# Agent Instructions for Fantasy Viz

## Project Overview

This is a Fantasy Football visualization app with:

- **Backend**: Express + TypeScript with tsoa (decorator-based API like Spring Boot)
- **Frontend**: React + TypeScript with Vite
- **API Documentation**: Auto-generated Swagger UI via tsoa at `/api-docs`

## Important Patterns & Conventions

### TypeScript/tsoa Controller Guidelines

1. **Parameter Order in Controller Methods**

   - `@Request()` parameters MUST come FIRST (they are required)
   - `@Path()` parameters come next (required)
   - `@Query()` optional parameters come LAST
   - **Example:**
     ```typescript
     public async myMethod(
       @Request() request: any,      // Required - must be first
       @Path() id: string,            // Required path param
       @Query() week?: number         // Optional query param - last
     ): Promise<Response> { }
     ```
   - **Error if wrong:** "A required parameter cannot follow an optional parameter"

2. **File Naming Conventions**

   - Class files should match the class name (like Java):
     - `FantasyService.ts` contains `FantasyService` class
     - `LeagueController.ts` contains `LeagueController` class
   - NOT `services.ts` for multiple services - use individual files

3. **Auto-generated Files (add to .gitignore)**

   - `server/src/routes.ts` - Generated by tsoa
   - `server/src/swagger.json` - Generated by tsoa
   - These are regenerated on every build via `npm run tsoa:gen`

4. **Decorator Best Practices**
   - Use `@Route()`, `@Tags()`, `@Get()`, `@Post()`, etc. like Spring annotations
   - Add `@Security("cookieAuth")` for authenticated endpoints
   - Use `@Response<ErrorResponse>()` for each error status code
   - Document with `@summary` and `@example` in JSDoc comments

### Logging & Debug Code Policy

**What to KEEP:**

- Server startup messages in `index.ts` (e.g., "Server running at...", "Swagger UI available at...")
- `console.error()` in catch blocks for production debugging
- Critical warnings that indicate data issues (e.g., "Player not found")

**What to REMOVE:**

- `console.log()` for debugging/tracing execution flow
- `console.log()` for parameter logging ("Called with...", "Fetching...")
- `console.log()` for step-by-step progress ("Processing...", "Found X items...")
- `console.warn()` for non-critical validation failures
- Cache hit/miss logging (performance debugging)
- File write operations for debugging (`fs.writeFileSync("debug-*.json")`)
- Test/investigation scripts (`test-*.js`, `run-*.js`)
- Token extraction helper scripts

**Cleanup Guidelines:**

- When implementing a feature, add minimal logging for development
- Before committing, remove debug logs that aren't needed in production
- If you add debug file writes, add the pattern to `.gitignore` immediately
- Remove investigation/test scripts once the issue is resolved
- Keep error logging simple: let errors bubble up with clear messages

### Code Quality Maintenance

**Dead Code Removal:**
When you notice any of these, remove them immediately:

- Unused imports in controllers/services
- Exported functions that are never imported elsewhere
- Methods in services that are never called from controllers
- Optional interface fields that are never set/used
- Test scripts and documentation from completed investigations
- Commented-out code blocks (if > 1 week old)

**Before Committing:**

- [ ] Remove all `console.log()` debugging statements
- [ ] Check for unused imports and functions
- [ ] Remove any test scripts created during investigation
- [ ] Remove debug file writes and helper scripts
- [ ] Verify `.gitignore` includes any debug file patterns
- [ ] Run build to ensure no compilation errors

### Error Handling

- Always use try-catch in service methods
- Set appropriate HTTP status codes:
  - `400` - Bad request / invalid input
  - `401` - Not authenticated
  - `404` - Resource not found
  - `504` - Gateway timeout
  - `500` - Server error
- Add request timeouts (10s recommended) to prevent hanging
- Return clear error messages to help debugging

### Building & Running

- **Development**: `npm run dev` (runs `tsoa:gen` then starts server)
- **Build**: `npm run build` (generates tsoa files + compiles TypeScript)
- **Check Errors**: Always run `get_errors` after making changes
- Server runs on `https://localhost:5000` (HTTPS in dev mode)
- Swagger UI available at `https://localhost:5000/api-docs`

### API Structure

The API follows this pattern:

1. **League endpoint** returns team keys
2. **Team roster endpoint** returns player keys and data
3. **Player comparison endpoint** aggregates player stats across weeks

Example keys:

- League: `461.l.329011`
- Team: `461.l.329011.t.2`
- Player: `461.p.{player_id}`

## Common Issues to Check

- [ ] Optional parameters must come after required parameters in tsoa controllers
- [ ] Request timeout added to prevent API hangs (10s recommended)
- [ ] Appropriate HTTP status codes used for errors
- [ ] Auto-generated files (`routes.ts`, `swagger.json`) in `.gitignore`
- [ ] File names match class names (FantasyService.ts not services.ts)
- [ ] All dependencies properly imported (axios, express, etc.)
- [ ] No debug `console.log()` statements (only `console.error()` in catch blocks)
- [ ] No test scripts or debug files committed to repo
- [ ] No unused imports or dead code in services/controllers
